<script>
  function formatWA(wa) {
    wa = wa.replace(/\D/g, '');
    if (wa.startsWith("08")) return "62" + wa.substring(1);
    if (wa.startsWith("+62")) return wa.replace("+62", "62");
    return wa;
  }

  function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
  }

  function showResult(type, icon, title, message, dateInfo = null, kode = '') {
    const resultDiv = document.getElementById('result');
    const btnLanjut = document.getElementById('btnLanjutManual');
    let dateHtml = '';

    if (dateInfo) {
      dateHtml = `
        <div class="date-info">
          <div><span>Status:</span><span>${dateInfo.status_text}</span></div>
          <div><span>Aktif Mulai:</span><span>${dateInfo.mulai}</span></div>
          <div><span>Berlaku Sampai:</span><span>${dateInfo.expired}</span></div>
        </div>
      `;
    }

    resultDiv.innerHTML = `
      <div class="result-box ${type} show">
        <i class="fas ${icon}"></i>
        <h3>${title}</h3>
        <p>${message}</p>
        ${dateHtml}
      </div>
    `;

    if (type === 'success' && kode) {
      btnLanjut.href = "/panduan/?kode=" + encodeURIComponent(kode);
      btnLanjut.style.display = "flex";
    } else {
      btnLanjut.style.display = "none";
    }
  }

  function cekKode() {
    const nama = document.getElementById("nama").value.trim();
    const wa = document.getElementById("wa").value.trim();
    const kode = document.getElementById("kode").value.trim();
    const button = document.getElementById("btnCek");

    document.getElementById('result').innerHTML = "";
    document.getElementById('btnLanjutManual').style.display = 'none';

    if (nama.length < 3) return showResult('error','fa-times-circle','Nama Tidak Valid','Nama minimal 3 karakter.');
    if (wa.replace(/\D/g,'').length < 10) return showResult('error','fa-times-circle','Nomor Tidak Valid','Nomor WhatsApp minimal 10 digit.');
    if (kode.length < 6) return showResult('error','fa-times-circle','Kode Tidak Valid','Kode minimal 6 karakter.');

    button.disabled = true;
    button.classList.add('loading');

    const formattedWA = formatWA(wa);
    const scriptURL = "https://script.google.com/macros/s/AKfycby9fuehTsnTzQBgh39RaywCHcCQAKZeda_2Z8MVp-TLC2H1A4f2SEhrTUV9FkE4mTpX/exec";

    fetch(`${scriptURL}?kode=${encodeURIComponent(kode)}&nama=${encodeURIComponent(nama)}&wa=${encodeURIComponent(formattedWA)}&_=${Date.now()}`)
      .then(res => res.json())
      .then(jsonData => {

        button.disabled = false;
        button.classList.remove('loading');

        // === SUCCESS (pertama kali aktivasi) ===
        if (jsonData.status === "SUCCESS") {

          const dateInfo = {
            status_text: "AKTIF",
            mulai: formatDate(jsonData.tanggal_mulai),
            expired: formatDate(jsonData.tanggal_expired)
          };

          showResult('success','fa-check-circle','Kode Berhasil Diaktifkan ðŸŽ‰','Mengalihkan ke panduan...',dateInfo,kode);

          setTimeout(() => {
            window.location.href = "/panduan/?kode=" + encodeURIComponent(kode);
          }, 2000);
        }

        // === SUDAH AKTIF / SUDAH DIGUNAKAN ===
        else if (jsonData.status === "USED" || jsonData.status === "ACTIVE") {

          const dateInfo = {
            status_text: "MASIH AKTIF",
            mulai: formatDate(jsonData.tanggal_mulai),
            expired: formatDate(jsonData.tanggal_expired)
          };

          showResult('success','fa-unlock','Kode Masih Aktif','Silakan lanjut ke panduan.',dateInfo,kode);
        }

        // === EXPIRED ===
        else if (jsonData.status === "EXPIRED") {

          const dateInfo = {
            status_text: "KADALUARSA",
            mulai: formatDate(jsonData.tanggal_mulai),
            expired: formatDate(jsonData.tanggal_expired)
          };

          showResult('warning','fa-calendar-times','Kode Sudah Expired','Masa berlaku sudah habis.',dateInfo);
        }

        // === INVALID ===
        else {
          showResult('error','fa-times-circle','Kode Tidak Valid','Kode tidak ditemukan.');
        }
      })
      .catch(() => {
        button.disabled = false;
        button.classList.remove('loading');
        showResult('error','fa-exclamation-triangle','Kesalahan Jaringan','Tidak bisa terhubung ke server.');
      });
  }

  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') cekKode();
  });
</script>
